version: '3.8'

# Docker Compose setup for E2E testing
# Includes infrastructure services and applications needed for complete E2E tests
# API and Platform Worker are included to test full command processing flow

services:
  # PostgreSQL Database
  postgres:
    image: postgres:16-alpine
    container_name: e2e-postgres
    environment:
      POSTGRES_DB: reliable
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
    ports:
      - "5432:5432"
    healthcheck:
      test: [ "CMD-SHELL", "pg_isready -U postgres" ]
      interval: 5s
      timeout: 5s
      retries: 10
    networks:
      - e2e-network

  # IBM MQ - using smaller resource limits for CI/CD
  ibmmq:
    image: ${IBM_MQ_IMAGE:-icr.io/ibm-messaging/mq:9.4.4.0-r1}
    platform: ${DOCKER_PLATFORM:-linux/amd64}
    container_name: e2e-ibmmq
    environment:
      LICENSE: accept
      MQ_QMGR_NAME: QM1
      MQ_APP_PASSWORD: passw0rd
      MQ_ADMIN_PASSWORD: passw0rd
    ports:
      - "1414:1414"
      - "9443:9443"
    healthcheck:
      test: [ "CMD", "dspmq" ]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 30s
    networks:
      - e2e-network

  # Kafka - using KRaft mode (no Zookeeper needed)
  kafka:
    image: confluentinc/cp-kafka:7.6.0
    container_name: e2e-kafka
    environment:
      KAFKA_NODE_ID: 1
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: 'CONTROLLER:PLAINTEXT,PLAINTEXT:PLAINTEXT,PLAINTEXT_HOST:PLAINTEXT'
      KAFKA_ADVERTISED_LISTENERS: 'PLAINTEXT://kafka:29092,PLAINTEXT_HOST://localhost:9092'
      KAFKA_PROCESS_ROLES: 'broker,controller'
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
      KAFKA_CONTROLLER_QUORUM_VOTERS: '1@kafka:29093'
      KAFKA_LISTENERS: 'PLAINTEXT://kafka:29092,CONTROLLER://kafka:29093,PLAINTEXT_HOST://0.0.0.0:9092'
      KAFKA_INTER_BROKER_LISTENER_NAME: 'PLAINTEXT'
      KAFKA_CONTROLLER_LISTENER_NAMES: 'CONTROLLER'
      CLUSTER_ID: 'MkU3OEVBNTcwNTJENDM2Qk'
      KAFKA_LOG_DIRS: '/tmp/kraft-combined-logs'
    ports:
      - "9092:9092"
    healthcheck:
      test: [ "CMD", "kafka-broker-api-versions", "--bootstrap-server", "localhost:9092" ]
      interval: 10s
      timeout: 10s
      retries: 10
      start_period: 30s
    networks:
      - e2e-network

  # API Application
  api:
    build:
      context: .
      dockerfile: msg-platform-api/Dockerfile
    container_name: e2e-api
    ports:
      - "8080:8080"
    environment:
      MICRONAUT_SERVER_PORT: 8080
      POSTGRES_HOST: postgres
      POSTGRES_PORT: 5432
      POSTGRES_DB: reliable
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
      MQ_HOST: ibmmq
      MQ_PORT: 1414
      MQ_QMGR: QM1
      MQ_CHANNEL: DEV.APP.SVRCONN
      MQ_USER: app
      MQ_PASS: passw0rd
      KAFKA_BOOTSTRAP_SERVERS: kafka:29092
      JMS_CONSUMERS_ENABLED: false
    depends_on:
      postgres:
        condition: service_healthy
      ibmmq:
        condition: service_healthy
      kafka:
        condition: service_healthy
    healthcheck:
      test: [ "CMD", "wget", "--spider", "-q", "http://localhost:8080/health" ]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 60s
    networks:
      - e2e-network

  # Platform Worker Application
  worker:
    build:
      context: .
      dockerfile: msg-platform-worker/Dockerfile
    container_name: e2e-worker
    ports:
      - "9090:9090"
    environment:
      WORKER_ID: e2e-worker-1
      MICRONAUT_SERVER_PORT: 9090
      POSTGRES_HOST: postgres
      POSTGRES_PORT: 5432
      POSTGRES_DB: reliable
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
      MQ_HOST: ibmmq
      MQ_PORT: 1414
      MQ_QMGR: QM1
      MQ_CHANNEL: DEV.APP.SVRCONN
      MQ_USER: app
      MQ_PASS: passw0rd
      KAFKA_BOOTSTRAP_SERVERS: kafka:29092
      JMS_CONSUMERS_ENABLED: true
      JMS_CONCURRENCY: 10
      OUTBOX_SWEEP_INTERVAL: 1s
      OUTBOX_CLAIM_TIMEOUT: 1s
    depends_on:
      postgres:
        condition: service_healthy
      ibmmq:
        condition: service_healthy
      kafka:
        condition: service_healthy
    healthcheck:
      test: [ "CMD", "wget", "--spider", "-q", "http://localhost:9090/health" ]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 60s
    networks:
      - e2e-network

networks:
  e2e-network:
    driver: bridge

# Note: No volumes for E2E - data is ephemeral and cleaned up after tests
